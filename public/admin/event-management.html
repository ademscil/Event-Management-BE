<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Event Management - IT Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="css/admin-mockup.css">
  <link rel="stylesheet" href="css/utilities-mockup.css">
  <script src="js/auth.js"></script>
  <script src="js/mockup-auth-bridge.js"></script>
</head>
<body>

  <header class="admin-header">
    <div class="logo">
      <a href="dashboard" style="text-decoration:none;color:inherit;">
        <img src="/assets/img/logo.png" alt="Logo">
        <span>IT Survey Admin</span>
      </a>
    </div>
    <div class="user-info" style="position: relative;">
      <div class="user-dropdown" style="cursor: pointer; display: flex; align-items: center; gap: 6px;">
        <span id="user-display">Loading...</span>
        <span style="font-size: 10px;">&#9662;</span>
      </div>
      <div id="user-dropdown-menu" style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 120px; z-index: 1000; margin-top: 4px;">
        <div class="logout-action" style="padding: 8px 12px; cursor: pointer; font-size: 12px; color: #374151; transition: background-color 0.2s;">Logout</div>
      </div>
    </div>
    <script>
      window.logoutUser = async function() {
        if (window.Auth && typeof window.Auth.logout === "function") {
          await window.Auth.logout();
        }
        localStorage.removeItem("loggedIn");
        localStorage.removeItem("username");
        localStorage.removeItem("userRole");
        localStorage.removeItem("userName");
        window.location.href = "login";
      };
      
      window.toggleUserDropdown = function(event) {
        if (event) event.stopPropagation();
        const menu = document.getElementById('user-dropdown-menu');
        if (menu) {
          menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }
      };
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.user-info')) {
          const menu = document.getElementById('user-dropdown-menu');
          if (menu) {
            menu.style.display = 'none';
          }
        }
      });
    </script>
  </header>

  <div class="admin-container">

    <aside class="admin-sidebar">
      <ul class="menu" id="sidebar-menu">
      </ul>
    </aside>

    <main class="admin-content">
      <div class="page-head">
        <div>
          <h1>Event Management</h1>
          <div class="page-subtitle">Admin Superuser membuat draft kosong, Admin Event melanjutkan desain & mapping.</div>
        </div>
        <div class="page-actions" id="page-actions">
          <button class="btn btn-primary" id="btn-create-survey" style="display: none;">+ Create Survey Event</button>
        </div>
      </div>

      <div class="panel">
        <h2>Filter</h2>
        <div class="filter-grid filter-grid-reference">
          <div class="form-group">
            <label>Period</label>
            <div style="display: flex; gap: 8px;">
              <input type="date" id="filter-start" value="2026-01-01" style="width: 48%;">
              <input type="date" id="filter-end" value="2026-12-31" style="width: 48%;">
            </div>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="filter-status">
              <option value="all">All</option>
              <option value="Draft Empty">Draft Empty</option>
              <option value="In Design">In Design</option>
              <option value="Active">Active</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>Daftar Event</h2>
          <span class="text-small text-muted">Showing 3 of 18 surveys</span>
        </div>

        <div class="survey-table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>Nama Event</th>
                <th>BU Target</th>
                <th>Admin Event</th>
                <th>Periode</th>
                <th>Status</th>
                <th>Last Edited</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody>
              <tr data-name="Survey Corp IT & BPM" data-owner="Corp IT" data-status="Active" data-start="2026-01-01" data-end="2026-01-31">
                <td>Survey Corp IT & BPM</td>
                <td>Corporate, Main Dealer</td>
                <td>Firman</td>
                <td>01 Jan - 31 Jan 2026</td>
                <td><span class="badge badge-active">Active</span></td>
                <td>Yesterday</td>
                <td>
                  <button class="btn btn-secondary js-continue-design" data-template="corp-it-bpm">Continue Design</button>
                </td>
              </tr>
              <tr data-name="Survey IT SM" data-owner="IT SM" data-status="In Design" data-start="2026-01-05" data-end="2026-01-25">
                <td>Survey IT SM</td>
                <td>IT SM</td>
                <td>Arif</td>
                <td>05 Jan - 25 Jan 2026</td>
                <td><span class="badge badge-warning">In Design</span></td>
                <td>2 days ago</td>
                <td>
                  <button class="btn btn-secondary js-continue-design" data-template="it-sm">Continue Design</button>
                  <a class="btn btn-secondary" href="event-management?action=assign-it-lead">Assign IT Lead</a>
                </td>
              </tr>
              <tr data-name="Survey IT SM (Draft kosong)" data-owner="IT SM" data-status="Draft Empty" data-start="" data-end="">
                <td>Survey IT SM (Draft kosong)</td>
                <td>IT SM</td>
                <td>-</td>
                <td>-</td>
                <td><span class="badge badge-draft">Draft Empty</span></td>
                <td>Just now</td>
                <td>
                  <a class="btn btn-secondary" href="event-management?action=assign-admin-event">Assign Admin Event</a>
                  <button class="btn btn-secondary js-continue-design" data-template="draft-empty">Continue Design</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="panel survey-list-panel">
        <div class="panel-header">
          <h2>Operational Controls</h2>
          <span class="text-small text-muted">Send and collect responses.</span>
        </div>
        <div style="display: grid; gap: 16px;">
          <div class="form-group" style="max-width: 360px;">
            <label>Survey</label>
            <select id="collectSurvey" >
              <option value="survey1">Survey Corp IT &amp; BPM</option>
              <option value="survey2">Survey IT SM</option>
              <option value="survey3">Survey IT Digital</option>
            </select>
          </div>
          <div style="display: flex; align-items: center; gap: 12px; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; background: #f9fafb;">
            <div style="flex: 1; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 12px; color: #6b7280;">Link</span>
              <input type="text" id="collectLink" value="" placeholder="Click Generate Link first" style="flex: 1; border: none; background: transparent; font-size: 13px; color: #111827; outline: none;" readonly>
            </div>
            <label style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: #6b7280; white-space: nowrap;">
              <input type="checkbox" id="shortenLink"> Shorten URL
            </label>
            <button class="btn btn-primary" id="btn-generate-link">Generate Link</button>
            <button class="btn btn-secondary" id="btn-copy-link">Copy link</button>
          </div>

          <div class="tabs collect-tabs" style="margin-bottom: 0;">
            <button class="tab active" data-tab="send">Invitation</button>
            <button class="tab" data-tab="qr">QR Code</button>
            <button class="tab" data-tab="embed">Embed</button>
          </div>

          <div id="collect-tab-send" style="display: block;">
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;">
              <div class="form-group">
                <label>To</label>
                <input type="text" placeholder="People name, Teams group or channel...">
              </div>
              <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                <div style="font-size: 12px; color: #6b7280;">Invitation preview</div>
                <label style="display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: #374151;">
                  <input type="checkbox" id="embedCoverToggle" checked > Embed cover
                </label>
              </div>
              <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; background: #f9fafb; margin-bottom: 12px;">
                <div id="embedCoverImage" style="height: 120px; border-radius: 10px; background: linear-gradient(135deg, #c7d2fe, #e0f2fe); display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 12px; margin-bottom: 10px;">Cover image</div>
                <div id="inviteSurveyTitle" style="font-weight: 600; font-size: 14px; color: #111827;">Survey Corp IT &amp; BPM</div>
                <div style="font-size: 12px; color: #6b7280;">You are invited to complete this survey.</div>
              </div>
              <div class="form-group">
                <label>Message</label>
                <textarea id="collectMessage" rows="4" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">Hi! Would you mind taking 2 minutes to complete this form? It would help us improve our service.</textarea>
              </div>
              <div style="border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fafafa; margin-bottom: 12px;">
                <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">Blast Schedule</div>
                <div class="form-group" style="margin-bottom: 8px;">
                  <label>Mode</label>
                  <select id="blastScheduleType" >
                    <option value="once" selected>Once</option>
                    <option value="recurring">Recurring</option>
                  </select>
                </div>
                <div id="blast-once-fields" style="display: none;">
                  <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                      <label>Date &amp; Time</label>
                      <input type="datetime-local" id="blastOnceDate">
                    </div>
                  </div>
                </div>
                <div id="blast-recurring-fields" style="display: none;">
                  <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                      <label>Start Date &amp; Time</label>
                      <input type="datetime-local" id="blastRecurringStartDate">
                    </div>
                    <div class="form-group" style="flex: 1;">
                      <label>Frequency</label>
                      <select id="blastRecurringFreq">
                        <option value="daily">Daily</option>
                        <option value="weekly" selected>Weekly</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              <div style="display: flex; justify-content: flex-end;">
                <button class="btn btn-primary" id="btn-send-invite">Send</button>
              </div>
            </div>
          </div>

          <div id="collect-tab-qr" style="display: none;">
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center;">
              <div style="width: 220px; height: 220px; margin: 0 auto 16px auto; border: 2px dashed #d1d5db; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #6b7280; font-size: 13px;">
                QR Code
              </div>
              <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">Recipients can scan the code to access the form.</div>
              <button class="btn btn-secondary" id="btn-download-qr">Download</button>
            </div>
          </div>

          <div id="collect-tab-embed" style="display: none;">
            <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;">
              <div style="font-size: 13px; color: #374151; margin-bottom: 10px;">Copy this code and paste it in a webpage.</div>
              <div style="display: flex; gap: 10px; align-items: center;">
                <textarea id="embedCode" rows="3" style="flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 12px; color: #111827;" readonly><!-- Generate link first --></textarea>
                <button class="btn btn-secondary" id="btn-copy-embed">Copy</button>
              </div>
            </div>
          </div>

          <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;">
            <div style="font-weight: 600; margin-bottom: 10px;">Reminder</div>
            <div class="form-group">
              <label>Recipients</label>
              <input type="text" id="reminderRecipients" placeholder="app-portalb2b@component.astra.co.id">
            </div>
            <div class="form-group">
              <label>Reminder Message</label>
              <textarea id="reminderMessage" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 13px;">Reminder: Mohon isi survey yang sedang berjalan. Terima kasih.</textarea>
            </div>
            <div style="border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; background: #fafafa; margin-bottom: 12px;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px;">Reminder Schedule</div>
              <div class="form-group" style="margin-bottom: 8px;">
                <label>Mode</label>
                <select id="reminderScheduleType" >
                  <option value="once" selected>Once</option>
                  <option value="recurring">Recurring</option>
                </select>
              </div>
              <div id="reminder-once-fields" style="display: none;">
                <div style="display: flex; gap: 10px;">
                  <div class="form-group" style="flex: 1;">
                    <label>Date &amp; Time</label>
                    <input type="datetime-local" id="reminderOnceDate">
                  </div>
                </div>
              </div>
              <div id="reminder-recurring-fields" style="display: none;">
                <div style="display: flex; gap: 10px;">
                  <div class="form-group" style="flex: 1;">
                    <label>Start Date &amp; Time</label>
                    <input type="datetime-local" id="reminderRecurringStartDate">
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <label>Frequency</label>
                    <select id="reminderRecurringFreq">
                      <option value="daily">Daily</option>
                      <option value="weekly" selected>Weekly</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div style="display: flex; justify-content: flex-end;">
              <button class="btn btn-secondary" id="btn-send-reminder">Send Reminder</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Create Survey Modal -->
  <div id="createSurveyModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 12px; width: 90%; max-width: 500px; overflow: hidden;">
      <div style="padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Create Survey Event</h2>
        <button class="js-close-create-modal" style="width: 32px; height: 32px; border-radius: 8px; border: 1px solid #d1d5db; background: white; cursor: pointer; font-size: 18px; color: #6b7280;">&times;</button>
      </div>
      <div style="padding: 24px;">
        <div class="form-group">
          <label>Survey Name <span style="color: #dc2626;">*</span></label>
          <input type="text" id="surveyName" placeholder="e.g. Survey Corp IT & BPM 2026">
        </div>
        <div class="form-group">
          <label>Admin Event Target <span style="color: #dc2626;">*</span></label>
          <input type="text" id="surveyAdminEvent" placeholder="e.g. Firman, Arif">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="surveyDesc" rows="3" placeholder="Survey description"></textarea>
        </div>
      </div>
      <div style="padding: 12px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 8px; justify-content: flex-end; background: #f9fafb; border-radius: 0 0 12px 12px;">
        <button class="btn btn-secondary js-close-create-modal">Cancel</button>
        <button class="btn btn-primary" id="btn-submit-create-modal">Create</button>
      </div>
    </div>
  </div>

  <script>
    const draftTemplates = {
      'corp-it-bpm': {
        title: 'Survey Corp IT & BPM',
        description: 'Mengukur kepuasan layanan IT & BPM di seluruh BU.',
        targetResponden: 200,
        targetScore: 8.5,
        schedule: { start: '2026-01-01', end: '2026-01-31' },
        theme: { backgroundColor: '#f6f9ff', fontFamily: '"Figtree", sans-serif', logo: '', backgroundImage: '' },
        pages: [
          {
            id: 1,
            title: 'Welcome',
            elements: [
              { id: 1, type: 'hero', title: 'Corporate IT & BPM Survey 2026', subtitle: '', required: false, options: [], coverUrl: '', imageUrl: null }
            ]
          },
          {
            id: 2,
            title: 'Profil Responden',
            elements: [
              { id: 2, type: 'dropdown', title: 'Business Unit', subtitle: '', required: true, options: ['Corporate', 'Main Dealer', 'Logistics'], optionImages: [null, null, null], imageUrl: null },
              { id: 3, type: 'text', title: 'Nama Lengkap', subtitle: '', required: true, options: [], imageUrl: null },
              { id: 4, type: 'text', title: 'Email', subtitle: '', required: true, options: [], imageUrl: null }
            ]
          }
        ]
      },
      'it-sm': {
        title: 'Survey IT SM',
        description: 'Feedback untuk Service Management IT SM.',
        targetResponden: 120,
        targetScore: 8.0,
        schedule: { start: '2026-01-05', end: '2026-01-25' },
        theme: { backgroundColor: '#f9fafb', fontFamily: '"Figtree", sans-serif', logo: '', backgroundImage: '' },
        pages: [
          {
            id: 1,
            title: 'Informasi User',
            elements: [
              { id: 1, type: 'text', title: 'Nama', subtitle: '', required: true, options: [], imageUrl: null },
              { id: 2, type: 'dropdown', title: 'Department', subtitle: '', required: true, options: ['IT SM', 'IT APP', 'IT INFRA'], optionImages: [null, null, null], imageUrl: null }
            ]
          },
          {
            id: 2,
            title: 'Penilaian Layanan',
            elements: [
              { id: 3, type: 'rating', title: 'Seberapa puas Anda terhadap layanan IT SM?', subtitle: '', required: true, options: [], imageUrl: null, maxRating: 5, ratingStyle: 'star', hasReason: true, reasonRequiredIfBelow: 3 }
            ]
          }
        ]
      }
    };

    (function() {
      const userRole = localStorage.getItem('userRole');
      if (userRole === 'admin_superuser') {
        const btn = document.getElementById('btn-create-survey');
        if (btn) btn.style.display = 'inline-flex';
      }
    })();

    function continueDesign(key) {
      const data = draftTemplates[key];
      if (data) {
        localStorage.setItem('survey_draft', JSON.stringify(data));
      } else {
        localStorage.removeItem('survey_draft');
      }
      window.location.href = 'survey-create';
    }

    function openCreateSurveyModal() {
      document.getElementById('createSurveyModal').style.display = 'flex';
    }

    function closeCreateSurveyModal() {
      document.getElementById('createSurveyModal').style.display = 'none';
      document.getElementById('surveyName').value = '';
      document.getElementById('surveyAdminEvent').value = '';
      document.getElementById('surveyDesc').value = '';
    }

    function createSurvey() {
      const name = document.getElementById('surveyName').value.trim();
      const adminEvent = document.getElementById('surveyAdminEvent').value.trim();
      
      if (!name || !adminEvent) {
        alert('Please fill all required fields');
        return;
      }
      
      alert('Survey event created successfully (mock)');
      closeCreateSurveyModal();
    }

    document.getElementById('createSurveyModal')?.addEventListener('click', function(e) {
      if (e.target === this) closeCreateSurveyModal();
    });

    function switchCollectTab(tabName) {
      const tabs = {
        send: 'collect-tab-send',
        qr: 'collect-tab-qr',
        embed: 'collect-tab-embed'
      };

      Object.values(tabs).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      document.querySelectorAll('.collect-tabs .tab').forEach(btn => btn.classList.remove('active'));
      const active = document.querySelector(`.collect-tabs .tab[data-tab="${tabName}"]`);
      if (active) active.classList.add('active');

      const target = document.getElementById(tabs[tabName]);
      if (target) target.style.display = 'block';
    }

    const generatedSurveyLinks = {};

    function buildSurveySlug(label) {
      return (label || '')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    function generateToken() {
      return `${Date.now().toString(36)}${Math.random().toString(36).slice(2, 8)}`.toUpperCase();
    }

    function generateCollectLink() {
      const select = document.getElementById('collectSurvey');
      if (!select) return;
      const option = select.options[select.selectedIndex];
      const surveyId = select.value;
      const surveySlug = buildSurveySlug(option?.textContent || surveyId);
      const token = generateToken();
      generatedSurveyLinks[surveyId] = {
        full: `https://survey.csi.internal/collect/${surveySlug}?token=${token}`,
        short: `https://s.csi.internal/${token.slice(-8)}`
      };
      updateCollectLinks();
    }

    function copyCollectLink() {
      const input = document.getElementById('collectLink');
      if (!input) return;
      if (!input.value) {
        alert('Generate link first');
        return;
      }
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(input.value);
      } else {
        input.select();
        document.execCommand('copy');
      }
      alert('Link copied');
    }

    function copyEmbedCode() {
      const textarea = document.getElementById('embedCode');
      if (!textarea) return;
      if (textarea.value.includes('Generate link first')) {
        alert('Generate link first');
        return;
      }
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(textarea.value);
      } else {
        textarea.select();
        document.execCommand('copy');
      }
      alert('Embed code copied');
    }

    function sendCollectInvite() {
      const schedule = getScheduleSummary('blast');
      alert(`Invitation sent (mock)\nSchedule: ${schedule}`);
    }

    function downloadQr() {
      alert('QR downloaded (mock)');
    }

    function updateCollectLinks() {
      const select = document.getElementById('collectSurvey');
      const input = document.getElementById('collectLink');
      const embed = document.getElementById('embedCode');
      const checkbox = document.getElementById('shortenLink');
      const title = document.getElementById('inviteSurveyTitle');
      if (!select || !input || !embed) return;
      const option = select.options[select.selectedIndex];
      const surveyId = select.value;
      const links = generatedSurveyLinks[surveyId];
      if (!links) {
        input.value = '';
        embed.value = '<!-- Generate link first -->';
      } else {
        const fullLink = links.full;
        const shortLink = links.short || fullLink;
        const embedLink = fullLink.includes('?') ? `${fullLink}&embed=true` : `${fullLink}?embed=true`;
        input.value = checkbox && checkbox.checked ? shortLink : fullLink;
        embed.value = `<iframe width="640px" height="480px" src="${embedLink}" frameborder="0" marginwidth="0" marginheight="0" style="border: none; max-width:100%; max-height:100vh" allowfullscreen webkitallowfullscreen mozallowfullscreen msallowfullscreen></iframe>`;
      }
      if (title) title.textContent = option.textContent.trim();
    }

    function sendReminder() {
      const schedule = getScheduleSummary('reminder');
      alert(`Reminder sent (mock)\nSchedule: ${schedule}`);
    }

    function toggleEmbedCover() {
      const checkbox = document.getElementById('embedCoverToggle');
      const cover = document.getElementById('embedCoverImage');
      if (!cover) return;
      cover.style.display = checkbox && checkbox.checked ? 'flex' : 'none';
    }

    function toggleScheduleFields(prefix) {
      const type = document.getElementById(`${prefix}ScheduleType`)?.value || 'once';
      const onceBox = document.getElementById(`${prefix}-once-fields`);
      const recurringBox = document.getElementById(`${prefix}-recurring-fields`);
      if (onceBox) onceBox.style.display = type === 'once' ? 'block' : 'none';
      if (recurringBox) recurringBox.style.display = type === 'recurring' ? 'block' : 'none';
    }

    function getScheduleSummary(prefix) {
      const type = document.getElementById(`${prefix}ScheduleType`)?.value || 'once';
      if (type === 'once') {
        const dateTime = document.getElementById(`${prefix}OnceDate`)?.value || '-';
        return `Once at ${dateTime}`;
      }
      const startDateTime = document.getElementById(`${prefix}RecurringStartDate`)?.value || '-';
      const freq = document.getElementById(`${prefix}RecurringFreq`)?.value || 'daily';
      return freq === 'weekly'
        ? `Recurring weekly from ${startDateTime}`
        : `Recurring daily from ${startDateTime}`;
    }

    (function initOperationalControls() {
      const openModalBtn = document.getElementById('btn-create-survey');
      if (openModalBtn) openModalBtn.addEventListener('click', openCreateSurveyModal);

      document.querySelectorAll('.js-close-create-modal').forEach((btn) => {
        btn.addEventListener('click', closeCreateSurveyModal);
      });

      const createBtn = document.getElementById('btn-submit-create-modal');
      if (createBtn) createBtn.addEventListener('click', createSurvey);

      document.querySelectorAll('.js-continue-design').forEach((btn) => {
        btn.addEventListener('click', () => continueDesign(btn.dataset.template || ''));
      });

      document.querySelectorAll('.collect-tabs .js-collect-tab').forEach((btn) => {
        btn.addEventListener('click', () => switchCollectTab(btn.dataset.tab || 'send'));
      });

      const collectSurvey = document.getElementById('collectSurvey');
      if (collectSurvey) collectSurvey.addEventListener('change', updateCollectLinks);

      const generateBtn = document.getElementById('btn-generate-link');
      if (generateBtn) generateBtn.addEventListener('click', generateCollectLink);

      const copyLinkBtn = document.getElementById('btn-copy-link');
      if (copyLinkBtn) copyLinkBtn.addEventListener('click', copyCollectLink);

      const copyEmbedBtn = document.getElementById('btn-copy-embed');
      if (copyEmbedBtn) copyEmbedBtn.addEventListener('click', copyEmbedCode);

      const sendInviteBtn = document.getElementById('btn-send-invite');
      if (sendInviteBtn) sendInviteBtn.addEventListener('click', sendCollectInvite);

      const downloadQrBtn = document.getElementById('btn-download-qr');
      if (downloadQrBtn) downloadQrBtn.addEventListener('click', downloadQr);

      const sendReminderBtn = document.getElementById('btn-send-reminder');
      if (sendReminderBtn) sendReminderBtn.addEventListener('click', sendReminder);

      const embedCoverToggle = document.getElementById('embedCoverToggle');
      if (embedCoverToggle) embedCoverToggle.addEventListener('change', toggleEmbedCover);

      const blastScheduleType = document.getElementById('blastScheduleType');
      if (blastScheduleType) {
        blastScheduleType.addEventListener('change', () => toggleScheduleFields('blast'));
      }

      const reminderScheduleType = document.getElementById('reminderScheduleType');
      if (reminderScheduleType) {
        reminderScheduleType.addEventListener('change', () => toggleScheduleFields('reminder'));
      }

      const checkbox = document.getElementById('shortenLink');
      if (checkbox) checkbox.addEventListener('change', updateCollectLinks);
      updateCollectLinks();
      toggleEmbedCover();
      toggleScheduleFields('blast');
      toggleScheduleFields('reminder');
    })();
  </script>

  <script src="js/mockup-sidebar.js"></script>
  <script src="js/user-menu.js"></script>
  <script src="js/filter-actions.js"></script>
  <script>
    (async function() {
      if (typeof window.__syncMockupAuth === "function") { window.__syncMockupAuth(); }
      const user = await window.AuthUtils.redirectIfNotAuthenticated("login");
      if (!user) return;
      if (user.role !== "SuperAdmin") { window.location.href = "dashboard"; }
      const userDisplay = document.getElementById("user-display");
      if (userDisplay) userDisplay.textContent = user.displayName || user.username || "Super Admin";
    })();
  </script>
</body>
</html>















